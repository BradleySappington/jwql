{% extends "base.html" %}

{% block preamble %}

	<title>View {{ inst }} Image - JWQL</title>

{% endblock %}

{% block content %}

    <main role="main" class="container">
    	<!-- Show image group name -->
    	<h3>{{ file_root }}</h3>

    	<!-- Specify the attributes of what is currently being shown -->
    	<div class="d-flex flex-row">
    		<div class="APT_parameters">Proposal: <a id="proposal" href="{{ url('jwql:archive_thumb', args=[inst, prop_id]) }}"></a></div>
    		<div class="APT_parameters">Observation: <a id="obs_id"></a></div>
    		<div class="APT_parameters">Visit: <a id="visit_id"></a></div>
    		<div class="APT_parameters">Detector: <a id="detector"></a></div>
    	</div>
    	FITS Filename: <a id="fits_filename"></a><br>
    	JPG Filename: <a id="jpg_filename"></a><br><br>

			<!-- Set meta data -->
			<meta id="image-data" data-inst="{{inst}}" data-suffix="{{suffixes}}" data-fileroot="{{file_root}}" data-numints="{{num_ints}}">

    	<!-- Allow the user to change the file type that is being displayed -->
    	View File Type:
    	<a href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/data_products/product_types.html" target="_blank">
	      	<span class="help-tip mx-1">i</span>
	    </a><br>
	    <form class="my-2" action="change_filetype(value, {{file_root}}, {{num_ints}}, {{inst}})">
	    	{% for suffix in suffixes %}
	    		<input type="radio" name="filetype" value="{{ suffix }}" id="{{ suffix }}" onclick='change_filetype("{{suffix}}", "{{file_root}}", "{{num_ints}}", "{{inst}}");'> {{ suffix }} &nbsp;&nbsp;&nbsp;&nbsp;
	    	{% endfor %}
		</form>
		<br>

		<!-- Buttons for viewing header, downloading files -->
		<p>
			<a id="view_header" class="btn btn-primary mx-2" role="button" href="#" onclick="setHeaderUrl()">View Header</a>
			<!-- <a id="download_fits" class="btn btn-primary my-2 mx-2" role="button" href='{{ static("") }}preview_images/{{ file_root[:7] }}/{{ file_root }}' download>Download FITS</a>
			<a id="download_jpg" class="btn btn-primary my-2 mx-2" role="button" href='{{ static("") }}preview_images/{{ file_root[:7] }}/{{ jpg }}' download>Download JPEG</a> -->
		</p>

        <div class="row">

            <!-- Display the image and integration buttons/slider -->
    	    <div class="col-xl-9 text-center">
    		    <span class="image_preview">
    		    	<img id="image_viewer"
                         src='{{ static("") }}preview_images/{{ file_root[:7] }}/{{ file_root }}_cal_integ0.jpg'
                         alt='{{ file_root }}_cal_integ0.jpg'
                         title="Preview image for {{ file_root }}">
    		    </span>

                <div class="int_changer">
                    <button id="int_before" class="btn btn-primary mx-2" role="button" onclick='change_int("{{file_root}}", "{{num_ints}}", "button", "left");' disabled>&#9664;</button>
                    <input type="range" min="1" max="5" value="1" class="slider" id="slider_range" onchange='change_int("{{file_root}}", "{{num_ints}}", "slider")'>
                    <button id="int_after" class="btn btn-primary mx-2" role="button" onclick='change_int("{{file_root}}", "{{num_ints}}", "button", "right");' disabled>&#9658;</button>
                    <p>Integration: <span id="slider_val"></span></p>
                </div>
            </div>
            
            <!-- Display the anomaly form -->
            <div class="col-xl-3 text-left">
                <!--Load the file search form from the view-->
                <div class="anomaly_form">
                    <h5>Submit Anomaly</h5>
                    <form action="" method="post">
                        <!--Show any errors from a previous form submission-->
                        {% if form.errors %}
                            <fieldset>
                                {% for field in form %}
                                    {% for error in field.errors %}
                                        <div class="alert alert-danger">
                                            <strong>{{ error|escape }}</strong>
                                        </div>
                                    {% endfor %}
                                {% endfor %}
                            </fieldset>
                        {% endif %}

                        <!--Django Cross-Site Request Forgery magic-->
                        {{ csrf_input }}

                        <!--Show the field forms-->
                        {% for field in form %}
                            {% for subwidget in field.subwidgets %}
                                <li class="anomaly_choice">{{subwidget}}</li>
                            {% endfor %}
                        {% endfor %}
                        <button class="btn btn-primary" type="submit" style="float: right;">Submit</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Update the current slider integration value while it is being dragged -->
        <script type="text/javascript">
        var slider = document.getElementById("slider_range")
        var slider_val = document.getElementById("slider_val")
        slider_val.innerHTML = slider.value; // Display the default slider value
        
        slider.oninput = function() {
          slider_val.innerHTML = this.value;
        }
        </script>

				<!-- Functions to determine which filetype should be shown on load and set the filetype for the header button -->
				<script type="text/javascript">
					var inst = $('#image-data').data().inst;
					var suffixes = $('#image-data').data().suffix.replace("[", "").replace("]", "").replaceAll("'", "").split(", ");
					var file_root = $('#image-data').data().fileroot;
					var num_ints = $('#image-data').data().numints;

					function onLoad() {
						if (suffixes.indexOf('cal') > -1){
							var initial_file_type = 'cal';
						}
						else if (suffixes.indexOf('rate') > -1) {
							var initial_file_type = 'rate';
						}
						else if (suffixes.indexOf('uncal') > -1) {
							var initial_file_type = 'uncal';
						}
						else {
							var initial_file_type = suffixes[0];
						}
						return initial_file_type
					}

					var initial_file_type = onLoad();
					change_filetype(initial_file_type, file_root, num_ints, inst);

					function setHeaderUrl() {
						console.log('setHeaderUrl');
							var file_type = document.querySelector('input[name=filetype]:checked').value;
							if (file_type == null){
									var file_type = onLoad();
							}
						}

				</script>


	</main>

{% endblock %}
